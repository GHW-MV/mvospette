{
    # Optional: reduce noisy logs, keep minimal errors
    log {
        level WARN
    }
}

mvospette.com {
    root * /opt/mvospette/static_site
    encode gzip zstd
    file_server

    # Friendly routes for HTML resources
    handle_path /sales_flyer* {
        rewrite * /sales_index.html
        file_server
    }
    handle_path /territory_map* {
        rewrite * /app
        file_server
    }
    handle_path /cloudflare_login* {
        rewrite * /cloudflare_login.html
        file_server
    }
    handle_path /cloudflare_denied* {
        rewrite * /cloudflare_denied.html
        file_server
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer-when-downgrade"
        Cache-Control "public, max-age=3600"
    }
}

app.mvospette.com {
    # Bearer auth via env (TERRITORY_API_TOKEN). Requests without/with wrong token get 401.
    @missing_auth not header Authorization
    @bad_auth not header Authorization "Bearer {env.TERRITORY_API_TOKEN}"
    respond @missing_auth 401
    respond @bad_auth 401

    # API first so /api/* is proxied correctly
    handle_path /api/* {
        reverse_proxy 127.0.0.1:8000
    }

    # Everything else -> Streamlit UI
    handle {
        reverse_proxy 127.0.0.1:8501
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer-when-downgrade"
    }
}
